;1 gdt
;2 base
;3 edge
;4 attr
%macro init_gdt 4
	;初始化代码段全局描述符表
	;段界限，2.5个字节
	xor eax,eax
	mov eax,%3
	mov word [%1],ax
	shr eax,16
	mov byte [%1+6],al
	;段基址，4个字节
	xor eax,eax
	mov eax,%2
	mov word [%1+2],ax
	shr eax,16
	mov byte [%1+4],al
	mov byte [%1+7],ah
	;段属性,1.5个字节
	xor eax,eax
	mov eax,%4
	mov byte [%1+5],al
	shr ax,8
	and ax,000f0h
	xor ebx,ebx
	mov bl,[%1+6]
	or  ax,bx
	mov byte [%1+6],al
%endmacro

;函数调用方式
;直接call或jmp
;系统级代码(非一致):CPL==DPL RPL<=DPL
;用户级调用(一致):CPL>=DPL

;门调用方式
;用户级调用(一致):CPL<=DPL_G RPL<=DPL_G CPL>=DPL_B
;系统级代码(非一致):
;jmp: CPL<=DPL_G RPL<=DPL_G CPL>=DPL_B
;call: CPL<=DPL_G RPL<=DPL_G CPL==DPL_B
;综上：
;门调用，不管是一致，还是非一致都可以调用高特权级的代码
;直接调用，在非一致时，只能调用同特权级代码，从这一点上可以说
;门调用更灵活一些，但所谓门调用，首先得过了门，所以调用者的特权级
;必须高于或等于门的特权级

;以上是代码段与代码段的特权转移，而对于数据段也有约定
;数据段规定了最低特权，高特权或等特权的代码段可以访问这些数据，
;门调用时，门也定义了最低特权，也只有高或等特权的代码才可以通过这些门
;可见门与数据段的定义是一样的
;但数据段与RPL没有关系，门要求RPL也要高于或等于最低特权

;----------------------------------------------------------------------------
; 描述符类型值说明
; 其中:
;       DA_  : Descriptor Attribute
;       D    : 数据段
;       C    : 代码段
;       S    : 系统段
;       R    : 只读
;       RW   : 读写
;       A    : 已访问
;       其它 : 可按照字面意思理解
;----------------------------------------------------------------------------

;         ┃ 7  ┃ P  ┃
;         ┣━━╉──┨
;         ┃ 6  ┃    ┃
;         ┣━━┫ DPL┃
;         ┃ 5  ┃    ┃
;         ┣━━╉──┨
;         ┃ 4  ┃ S  ┃
;  字节 5 ┣━━╉──┨
;         ┃ 3  ┃    ┃
;         ┣━━┫ T  ┃
;         ┃ 2  ┃ Y  ┃
;         ┣━━┫ P  ┃
;         ┃ 1  ┃ E  ┃
;         ┣━━┫    ┃
;         ┃ 0  ┃    ┃
						;			   
DA_32		EQU	4000h	; 32 位段   
DA_LIMIT_4K EQU 8000h   ; 页表粒度为4KB
						;			 			g d	avl e d g e   p dpl s
						;			 			7 6 5 4 3 2 1 0 | 7 6 5 4 3 2 1 0
                        ;            			8 4 2 1 8 4 2 1 | 8 4 2 1 8 4 2 1
DA_DPL0		EQU	  00h	; DPL = 0    							|   0 0
DA_DPL1		EQU	  20h	; DPL = 1    							|   0 1
DA_DPL2		EQU	  40h	; DPL = 2    							|   1 0 
DA_DPL3		EQU	  60h	; DPL = 3    							|   1 1
;----------------------------------------------------------------------------
; 存储段描述符类型值说明
;----------------------------------------------------------------------------
DA_DR		EQU	90h	; 存在的只读数据段类型值
DA_DRW		EQU	92h	; 存在的可读写数据段属性值
DA_DRWA		EQU	93h	; 存在的已访问可读写数据段类型值
DA_C		EQU	98h	; 存在的只执行代码段属性值
DA_CR		EQU	9Ah	; 存在的可执行可读代码段属性值
DA_CCO		EQU	9Ch	; 存在的只执行一致代码段属性值
DA_CCOR		EQU	9Eh	; 存在的可执行可读一致代码段属性值
;----------------------------------------------------------------------------
; 系统段描述符类型值说明
;----------------------------------------------------------------------------
DA_LDT		EQU	  82h	; 局部描述符表段类型值
DA_TaskGate	EQU	  85h	; 任务门类型值
DA_386TSS	EQU	  89h	; 可用 386 任务状态段类型值
DA_386CGate	EQU	  8Ch	; 386 调用门类型值
DA_386IGate	EQU	  8Eh	; 386 中断门类型值
DA_386TGate	EQU	  8Fh	; 386 陷阱门类型值
;----------------------------------------------------------------------------

; 选择子类型值说明
; 其中:
;       SA_  : Selector Attribute

SA_RPL0		EQU	0	; ┓
SA_RPL1		EQU	1	; ┣ RPL
SA_RPL2		EQU	2	; ┃
SA_RPL3		EQU	3	; ┛

SA_TIG		EQU	0	; ┓TI
SA_TIL		EQU	4	; ┛

;全局描述符表	
; 图示一
;
;  ------ ┏━━┳━━┓高地址
;         ┃ 7  ┃ 段 ┃
;         ┣━━┫    ┃
;                  基
;  字节 7 ┆    ┆    ┆
;                  址
;         ┣━━┫ ② ┃
;         ┃ 0  ┃    ┃
;  ------ ┣━━╋━━┫
;         ┃ 7  ┃ G  ┃
;         ┣━━╉──┨
;         ┃ 6  ┃ D  ┃
;         ┣━━╉──┨
;         ┃ 5  ┃ 0  ┃
;         ┣━━╉──┨
;         ┃ 4  ┃ AVL┃
;  字节 6 ┣━━╉──┨
;         ┃ 3  ┃    ┃
;         ┣━━┫ 段 ┃
;         ┃ 2  ┃ 界 ┃
;         ┣━━┫ 限 ┃
;         ┃ 1  ┃    ┃
;         ┣━━┫ ② ┃
;         ┃ 0  ┃    ┃
;  ------ ┣━━╋━━┫
;         ┃ 7  ┃ P  ┃
;         ┣━━╉──┨
;         ┃ 6  ┃    ┃
;         ┣━━┫ DPL┃
;         ┃ 5  ┃    ┃
;         ┣━━╉──┨
;         ┃ 4  ┃ S  ┃
;  字节 5 ┣━━╉──┨
;         ┃ 3  ┃    ┃
;         ┣━━┫ T  ┃
;         ┃ 2  ┃ Y  ┃
;         ┣━━┫ P  ┃
;         ┃ 1  ┃ E  ┃
;         ┣━━┫    ┃
;         ┃ 0  ┃    ┃
;  ------ ┣━━╋━━┫
;         ┃ 23 ┃    ┃
;         ┣━━┫    ┃
;         ┃ 22 ┃    ┃
;         ┣━━┫ 段 ┃
;
;   字节  ┆    ┆ 基 ┆
; 2, 3, 4
;         ┣━━┫ 址 ┃
;         ┃ 1  ┃ ① ┃
;         ┣━━┫    ┃
;         ┃ 0  ┃    ┃
;  ------ ┣━━╋━━┫
;         ┃ 15 ┃    ┃
;         ┣━━┫    ┃
;         ┃ 14 ┃    ┃
;         ┣━━┫ 段 ┃
;
; 字节 0,1┆    ┆ 界 ┆
;
;         ┣━━┫ 限 ┃
;         ┃ 1  ┃ ① ┃
;         ┣━━┫    ┃
;         ┃ 0  ┃    ┃
;  ------ ┗━━┻━━┛低地址

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;分页机制常用常量
PG_P		equ	1	; 页存在属性位
PG_RWR		equ	0	; R/W 属性位值, 读/执行
PG_RWW		equ	2	; R/W 属性位值, 读/写/执行
PG_USS		equ	0	; U/S 属性位值, 系统级
PG_USU		equ	4	; U/S 属性位值, 用户级